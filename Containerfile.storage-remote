FROM ghcr.io/ublue-os/ucore-minimal:stable-zfs@sha256:a03fc6a464aee28219d4d5fff56d3af770075f7044a4b02c98038c3e2c8bee32

ARG HOST

COPY .sops.yaml /usr/share/sops/

# Apps - Node-exporter
COPY apps/node-exporter/node-exporter.container /usr/share/containers/systemd/

# Apps - Scrutiny-collector
COPY apps/scrutiny-collector/storage-remote.container /usr/share/containers/systemd/scrutiny-collector.container
COPY apps/scrutiny-collector/storage-remote.sops.env /usr/share/scrutiny-collector/config.sops.env

# Apps - Wireguard
COPY apps/wireguard/wg0-client.sops.conf /usr/share/wireguard/wg0-client.sops.conf
COPY systemd/wg0-client.service /etc/systemd/system/

# Apps - Zrepl
COPY apps/zrepl /tmp/apps/zrepl
COPY systemd/zrepl-secrets.service /etc/systemd/system/


COPY systemd/ucore-update* /etc/systemd/system/
COPY systemd/ucore-firewalld-setup-storage-remote.service /etc/systemd/system/ucore-firewalld-setup.service
COPY systemd/ucore-zfs-kernel.service /etc/systemd/system/
COPY systemd/brew* /etc/systemd/system/

COPY scripts /tmp/

RUN /tmp/install.sh && \
    /tmp/post-install.sh && \
    ostree container commit